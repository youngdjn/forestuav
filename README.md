This is a collection of scripts for evaluating how different drone imagery collection and processing parameters influence the quality of automatically generated tree maps.

## Workflow
1) **Fly the study site** with multiple missions with different mission parameters (e.g., flight altitude, gimbal angle). Fly each mission at high image overlap so that photosets can be thinned later to additionally evaluate the influence of image overlap. The flight mission parameters used to acquire each photo set are recorded in `{data}/parameter_set_definitions/imagery-collection-log.csv`.
3) **Thin mission photosets** by selecting every *i*th photo in every *j*th transect (done by `scripts/thin_drone_photoset.R`). Thinned photosets are in `{data}/drone_image_sets_thinned/`. The nomenclature for the thinned photo sets is "setnumber_thin##", where the two thinning numbers, in order, are the forward thinning factor and the side thinning factor. For example, "set14_thin24" is photo set 14 thinned by a factor of 2 in the forward direction and a factor of 4 in the side direction.
4) **Create composite photosets** by combininng photo sets that have already been thinned (e.g., a nadir and oblique photo set). The individual photo sets used to create each composite photo set are recorded in `{data}/parameter_set_definitions/imagery-collection-log.csv`. Composite photo sets have a four-digit thinning code. The first two numbers are the forward thinning factors of the two contributing photo sets (in the order specified in `{data}/parameter_set_definitions/imagery-collection-log.csv`, and the second two numbers are the side thinning factors of the two photo sets.
5) **Prepare photo sets for photogrammetric processing** by adding GCP and DEM data into the root folder of each photo set as specified in the documentation of the [UC Davis Metashape scripts](https://github.com/ucdavis/metashape).
6) **Photogrammetrically process each thinned photoset in Metashape** to produce a digital surface model (DSM) and point cloud using different sets of Metashape parameters. Definitions of the flight and processig parameters associated with each set of Metashape outputs are in `{data}/parameter_set_definitions/photoset-processing-params.csv`. The photoset thinning codes specified in that file coorespond to the photoset naming conventions as described in **Thin mission photosets* and **Create composite photosets** above. Metashape is run using the [UC Davis Metashape scripts](https://github.com/ucdavis/metashape). This workflow involves using detailed YAML configuration files for each Metashape run to document the processing parameters and enable reproduction. The configuration files used are in `{data}/metashape_configs`. Runs were performed using [v0.1.0](https://github.com/ucdavis/metashape/releases/tag/v0.1.0) of the scripts. [This step is performed on a GPU machine.]
7) **Post-process the photogrammetric products** by cropping the DSM to the focal area, normalizing by subtracting the terrain elevation (from a USGS DEM) to yield a canopy height model, and upscaling it to a 0.12 m resolution (done by `scripts/crop_and_noralize_dsm.R`); and by cropping the point cloud to the focal area, decimating it to 50 pts per sq m, and normalizing it by subtracting the terrain elevation (done by `scripts/crop_and_thin_las.R`). The normalization approach we use is reasonable because the UC Davis Metashape scripts GCP workflow ties the drone imagery elevation to the USGS DEM elevation, and only GCPs at or very close to bare ground are used. The resulting products are in `{data}/metashape_outputs_postprocessed/`. For the CHMs, the naming convention is {photo set}\_{processing parameters}\_{Metashape processed date-time}\_{layer type}. The processing parameters value is composed of four or five digits. The final two digits correspond to the metashape processing parameter set (defined in `{data}/parameter_set_definitions/photoset-processing-params.csv`). The initial one or two digits (following the "1" that precedes all values) indicates the photoset thinning factors used (also as defined in `{data}/parameter_set_definitions/photoset-processing-params.csv`). For the point clouds, the naming convention is the same except there is not a preceding "1".
8) **Convert eash Metashape DSM to a canopy height model** (CHM) by using a 10 m USGS DEM to define the terrain elevation and subtracting that from the DSM (first interpolate \[downscale\] the USGS DEM to the Metashape DSM) (done by `scripts/metashape_dsm_to_chm.R`). 
9) **Process the digital surface model and/or point cloud into maps of estimated tree locations** using different tree detection algorithms. Scripts that do this are in `scripts/tree_detection`. Estimated tree stem map files are in `post_metashape_products/paramsetXXX/` where `paramsetXXX` is the name of the set of drone mission and metashape parameters yielding the data files from which the stem map was computed (defined in `{data}/parameter_set_definitions/`).
10) **Generate a map of tree stem locations from a ground-truth survey of the study area** (done by `scripts/ground_survey_to_spatial.R`).
11) **Spatially warp the ground-truth stem map to move trees into their "true" locations** (TO DO).
12) **Compare the drone-derived stem maps to the ground-truth stem map** (TO DO).

**Data:** Data are stored on Box at https://ucdavis.box.com/s/yxgngz750ommo73kz5akeac0q7ci5wgi (contact me for access). The top of every data-dependent script includes a line that can be changed to point to the top level of the data directory in your file system (e.g., via Box Drive). All data references within the scripts are appended to that top-level data directory path.
